; ═══════════════════════════════════════════════════════════
; PlatformIO Project Configuration File
; Smart Doorlock System v2.0
; ═══════════════════════════════════════════════════════════

[platformio]
; Default environment to build
default_envs = esp32dev

; Shared directory for all environments
src_dir = src
include_dir = include
lib_dir = lib
build_dir = .pio/build
libdeps_dir = .pio/libdeps

; ═══════════════════════════════════════════════════════════
; Common Settings - Shared by all environments
; ═══════════════════════════════════════════════════════════
[common]
; Build flags applied to all environments
build_flags = 
    -D ARDUINO_ARCH_ESP32
    -D CONFIG_ARDUHAL_LOG_COLORS
    -D CORE_DEBUG_LEVEL=3
    -D FIRMWARE_VERSION=\"2.0.0\"
    ; Add include paths for subdirectories
    -I src
    -I src/BSP
    -I src/Drivers
    -I src/Drivers/RFID
    -I src/Drivers/LCD
    -I src/Drivers/Keypad
    -I src/Drivers/Lock
    -I src/Drivers/Buzzer
    -I src/Drivers/LED
    -I src/App
    -I src/App/WiFiManager
    -I src/App/TelegramNotifier
    -I src/App/OTPManager
    -I src/App/PasswordManager
    -I src/App/MenuManager
    -I src/App/DoorlockController
    ; Uncomment to enable detailed debug output
    ; -D DEBUG_MODE=1
    ; -D DEBUG_RFID=1
    ; -D DEBUG_WIFI=1
    ; -D DEBUG_TELEGRAM=1

; Serial monitor settings
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder    ; Decode ESP32 exceptions
    colorize                   ; Colorize output
    time                       ; Add timestamps

; Common library dependencies
lib_deps_common = 
    ; RFID Reader Library
    miguelbalboa/MFRC522@^1.4.10
    
    ; LCD I2C Library
    marcoschwartz/LiquidCrystal_I2C@^1.1.4
    
    ; Keypad Library
    chris--a/Keypad@^3.1.1
    
    ; JSON Library (for Telegram API)
    bblanchon/ArduinoJson@^6.21.3

; ═══════════════════════════════════════════════════════════
; Main Development Environment - ESP32 DevKit V1
; ═══════════════════════════════════════════════════════════
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino

; Upload settings
upload_speed = 921600
upload_port = COM3              ; Change to your port (Windows: COM3, Linux: /dev/ttyUSB0, Mac: /dev/cu.usbserial)

; Monitor settings
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
monitor_port = COM3             ; Change to your port

; Build flags
build_flags = 
    ${common.build_flags}
    -D BOARD_HAS_PSRAM
    -D CONFIG_SPIRAM_CACHE_WORKAROUND

; Library dependencies
lib_deps = 
    ${common.lib_deps_common}

; Board configuration
board_build.partitions = default.csv
board_build.flash_mode = dio
board_build.f_cpu = 240000000L
board_build.f_flash = 40000000L

; ═══════════════════════════════════════════════════════════
; ESP32 with PSRAM Support (if your board has PSRAM)
; ═══════════════════════════════════════════════════════════
[env:esp32dev_psram]
extends = env:esp32dev
build_flags = 
    ${env:esp32dev.build_flags}
    -D BOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -D CONFIG_SPIRAM_SUPPORT=1
    -D CONFIG_SPIRAM_USE_MALLOC=1

; ═══════════════════════════════════════════════════════════
; Debug Configuration - For Development & Troubleshooting
; ═══════════════════════════════════════════════════════════
[env:esp32dev_debug]
extends = env:esp32dev
build_type = debug
build_flags = 
    ${env:esp32dev.build_flags}
    -D DEBUG_MODE=1
    -D DEBUG_RFID=1
    -D DEBUG_KEYPAD=1
    -D DEBUG_WIFI=1
    -D DEBUG_TELEGRAM=1
    -D CORE_DEBUG_LEVEL=5
    -O0                         ; No optimization - easier debugging
    -g3                         ; Maximum debug info

monitor_filters = 
    ${common.monitor_filters}
    log2file                    ; Save output to file

; Extra debugging scripts
extra_scripts = 
    ; Add custom debug scripts here if needed

; ═══════════════════════════════════════════════════════════
; Release Configuration - Optimized for Production
; ═══════════════════════════════════════════════════════════
[env:esp32dev_release]
extends = env:esp32dev
build_type = release
build_flags = 
    ${env:esp32dev.build_flags}
    -D RELEASE_MODE=1
    -D CORE_DEBUG_LEVEL=0       ; Disable debug output
    -Os                         ; Optimize for size
    -DNDEBUG                    ; Disable assertions

; Strip debug symbols to reduce size
build_unflags = 
    -g

; ═══════════════════════════════════════════════════════════
; OTA Update Configuration - For Wireless Updates
; ═══════════════════════════════════════════════════════════
[env:esp32dev_ota]
extends = env:esp32dev
upload_protocol = espota
upload_port = 192.168.1.100     ; Change to your ESP32 IP address
upload_flags = 
    --port=3232
    --auth=smartdoorlock2025    ; Change to your OTA password

; OTA partition scheme
board_build.partitions = min_spiffs.csv

; Additional OTA libraries
lib_deps = 
    ${env:esp32dev.lib_deps}
    ArduinoOTA

; ═══════════════════════════════════════════════════════════
; Test Environment - For Unit Testing
; ═══════════════════════════════════════════════════════════
[env:esp32dev_test]
extends = env:esp32dev
test_framework = unity
test_build_src = yes
build_flags = 
    ${env:esp32dev.build_flags}
    -D UNIT_TEST=1
    -D UNITY_INCLUDE_DOUBLE

; Test configuration
test_ignore = 
    test_desktop/*

; ═══════════════════════════════════════════════════════════
; USB CDC Configuration - For ESP32-S2/S3/C3
; ═══════════════════════════════════════════════════════════
[env:esp32s3_usb]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
upload_speed = 921600
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}

build_flags = 
    ${common.build_flags}
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D ARDUINO_USB_MODE=1

lib_deps = 
    ${common.lib_deps_common}

; ═══════════════════════════════════════════════════════════
; Linux/Mac Development Environment
; ═══════════════════════════════════════════════════════════
[env:esp32dev_unix]
extends = env:esp32dev
upload_port = /dev/ttyUSB0      ; Linux
; upload_port = /dev/cu.usbserial-*  ; Mac (uncomment for Mac)
monitor_port = /dev/ttyUSB0
monitor_speed = ${common.monitor_speed}

; ═══════════════════════════════════════════════════════════
; Custom Scripts Section
; ═══════════════════════════════════════════════════════════
; [env:custom]
; extra_scripts = 
;     pre:scripts/pre_build.py
;     post:scripts/post_build.py

; ═══════════════════════════════════════════════════════════
; Advanced Options
; ═══════════════════════════════════════════════════════════

; Uncomment to enable LTO (Link Time Optimization)
; build_flags = 
;     ${common.build_flags}
;     -flto

; Uncomment to set custom partition table
; board_build.partitions = custom_partitions.csv

; Uncomment to use custom bootloader
; board_build.bootloader = custom_bootloader.bin

; ═══════════════════════════════════════════════════════════
; NOTES
; ═══════════════════════════════════════════════════════════
; 
; Upload Methods:
; 1. USB Serial (default):
;    pio run -e esp32dev --target upload
; 
; 2. OTA (Over-The-Air):
;    pio run -e esp32dev_ota --target upload
; 
; Build Commands:
; - Build:           pio run
; - Upload:          pio run --target upload
; - Clean:           pio run --target clean
; - Monitor:         pio device monitor
; - Build + Upload:  pio run --target upload && pio device monitor
; 
; Debug Commands:
; - Debug build:     pio run -e esp32dev_debug
; - Release build:   pio run -e esp32dev_release
; - Test:            pio test
; 
; Port Detection:
; - List ports:      pio device list
; - Monitor:         pio device monitor -p COM3
; 
; Library Management:
; - Install lib:     pio lib install "LibraryName"
; - Update libs:     pio lib update
; - List libs:       pio lib list
; 
; ═══════════════════════════════════════════════════════════
